<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>飲食紀錄</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #fafafa;
}

.tabs {
  display: flex;
  margin: 10px;
  gap: 10px;
}

.tab {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  text-align: center;
  border: 1px solid #ccc;
  cursor: pointer;
  background: #fff;
}

.tab.active {
  background: #333;
  color: white;
}

.container {
  padding: 20px;
}

.meal-card,
.snack-card {
  border: 1px solid #ddd;
  border-radius: 14px;
  background: #fff;
  padding: 12px;
  margin-bottom: 12px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.section-title {
  font-weight: bold;
}

.select-btn,
.add-snack-btn,
.type-plus,
.modal-action,
.qty-btn {
  border: 1px solid #bbb;
  background: #fff;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
}

.add-snack-btn {
  width: 100%;
  font-size: 18px;
}

.items-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.consumable-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  background: #f4f4f4;
  border-radius: 10px;
  padding: 8px;
}

.item-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.item-sub {
  color: #666;
  font-size: 12px;
}

.qty-control {
  display: flex;
  align-items: center;
  gap: 6px;
}

.qty-input {
  width: 54px;
  text-align: center;
  padding: 4px;
  border-radius: 6px;
  border: 1px solid #bbb;
}

.floating {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: white;
  border-top: 2px solid #ccc;
  transition: height 0.3s;
  height: 54px;
  overflow: hidden;
}

.floating.expanded {
  height: 320px;
}

.floating-header {
  text-align: center;
  padding: 12px;
  cursor: pointer;
  background: #eee;
  font-weight: bold;
}

.total-grid {
  display: flex;
  padding: 10px;
}

.column {
  flex: 1;
  padding: 10px;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  z-index: 1000;
}

.modal-overlay.open {
  display: block;
}

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: min(760px, calc(100% - 20px));
  max-height: calc(100% - 20px);
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-banner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #ddd;
  background: #f8f8f8;
  position: sticky;
  top: 0;
}

.modal-title {
  font-weight: bold;
}

.modal-body {
  padding: 10px;
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 10px;
}

.type-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 8px;
  background: #fcfcfc;
}

.type-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.type-items {
  display: none;
  flex-wrap: wrap;
  gap: 6px;
}

.type-items.open {
  display: flex;
}

.option-chip {
  border: 1px solid #bbb;
  border-radius: 20px;
  padding: 5px 10px;
  background: #fff;
  cursor: pointer;
}

.option-chip.selected {
  background: #333;
  color: #fff;
  border-color: #333;
}
</style>
</head>
<body>

<div class="tabs">
  <div class="tab active" onclick="switchTab('daily', this)">每日</div>
  <div class="tab" onclick="switchTab('review', this)">回顧</div>
</div>

<div id="daily" class="container">
  <div id="mealContainer"></div>
</div>

<div id="review" class="container" style="display:none;">
  回顧頁籤即將推出。
</div>

<div class="floating" id="floating">
  <div class="floating-header" onclick="toggleFloating()">
    每日總攝取量
  </div>
  <div class="total-grid">
    <div class="column">
      <h4>建議減少</h4>
      <div>飽和脂肪：<span id="satFat">0</span> g</div>
      <div>添加糖：<span id="sugar">0</span> g</div>
      <div>鈉：<span id="sodium">0</span> mg</div>
    </div>
    <div class="column">
      <h4>建議增加</h4>
      <div>蛋白質：<span id="protein">0</span> g</div>
      <div>水溶性纖維：<span id="solFiber">0</span> g</div>
      <div>非水溶性纖維：<span id="insFiber">0</span> g</div>
      <div>鉀：<span id="potassium">0</span> mg</div>
      <div>鎂：<span id="magnesium">0</span> mg</div>
    </div>
  </div>
</div>

<div id="selectionModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-banner">
      <button class="modal-action" onclick="closeModal()">取消</button>
      <div class="modal-title">選擇可食項目</div>
      <button class="modal-action" onclick="confirmSelection()">選取</button>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script>
let totals = {
  saturatedFat: 0,
  addedSugar: 0,
  sodium: 0,
  protein: 0,
  solubleFiber: 0,
  insolubleFiber: 0,
  potassium: 0,
  magnesium: 0
};

let consumablesData = {};
let modalTargetList = null;
let selectedInModal = [];

fetch("consumables.json")
  .then(res => res.json())
  .then(data => {
    consumablesData = data;
    createMeals();
  });

function switchTab(tab, targetEl) {
  document.getElementById("daily").style.display = tab === 'daily' ? "block" : "none";
  document.getElementById("review").style.display = tab === 'review' ? "block" : "none";
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  targetEl.classList.add('active');
}

function toggleFloating() {
  document.getElementById("floating").classList.toggle("expanded");
}

function createMeals() {
  const meals = ["早餐", "午餐", "晚餐"];
  const container = document.getElementById("mealContainer");
  meals.forEach((meal) => {
    container.appendChild(createSectionCard(meal, 'meal-card'));
  });

  const snackTitle = document.createElement('h3');
  snackTitle.innerText = '點心';
  container.appendChild(snackTitle);

  const snackWrap = document.createElement('div');
  snackWrap.id = 'snackWrap';
  container.appendChild(snackWrap);

  const snackBtn = document.createElement('button');
  snackBtn.className = 'add-snack-btn';
  snackBtn.innerText = '+ 新增點心';
  snackBtn.onclick = addSnackSection;
  container.appendChild(snackBtn);
}

function createSectionCard(title, className) {
  const card = document.createElement('div');
  card.className = className;

  const header = document.createElement('div');
  header.className = 'section-header';

  const titleEl = document.createElement('div');
  titleEl.className = 'section-title';
  titleEl.innerText = title;

  const btn = document.createElement('button');
  btn.className = 'select-btn';
  btn.innerText = '選擇可食項目';

  const list = document.createElement('div');
  list.className = 'items-list';

  btn.onclick = () => openSelectionModal(list);

  header.appendChild(titleEl);
  header.appendChild(btn);
  card.appendChild(header);
  card.appendChild(list);

  return card;
}

function addSnackSection() {
  const snackWrap = document.getElementById('snackWrap');
  const count = snackWrap.children.length + 1;
  snackWrap.appendChild(createSectionCard(`點心 ${count}`, 'snack-card'));
}

function openSelectionModal(targetList) {
  modalTargetList = targetList;
  selectedInModal = [];
  document.getElementById('modalBody').innerHTML = '';

  Object.keys(consumablesData).forEach(typeName => {
    const card = document.createElement('div');
    card.className = 'type-card';

    const header = document.createElement('div');
    header.className = 'type-header';

    const title = document.createElement('span');
    title.innerText = typeName;

    const plusBtn = document.createElement('button');
    plusBtn.className = 'type-plus';
    plusBtn.innerText = '+';

    const itemWrap = document.createElement('div');
    itemWrap.className = 'type-items';

    plusBtn.onclick = () => {
      const isOpen = itemWrap.classList.toggle('open');
      plusBtn.innerText = isOpen ? '-' : '+';
      if (itemWrap.dataset.loaded === '1') return;
      const items = consumablesData[typeName] || [];
      items.forEach(item => {
        const chip = document.createElement('button');
        chip.className = 'option-chip';
        chip.innerText = item.name;
        chip.onclick = () => {
          chip.classList.toggle('selected');
          const exists = selectedInModal.some(sel => sel.name === item.name);
          if (exists) {
            selectedInModal = selectedInModal.filter(sel => sel.name !== item.name);
          } else {
            selectedInModal.push(item);
          }
        };
        itemWrap.appendChild(chip);
      });
      itemWrap.dataset.loaded = '1';
    };

    header.appendChild(title);
    header.appendChild(plusBtn);
    card.appendChild(header);
    card.appendChild(itemWrap);
    document.getElementById('modalBody').appendChild(card);
  });

  document.getElementById('selectionModal').classList.add('open');
}

function closeModal() {
  document.getElementById('selectionModal').classList.remove('open');
  selectedInModal = [];
}

function confirmSelection() {
  if (!modalTargetList || selectedInModal.length === 0) {
    closeModal();
    return;
  }

  selectedInModal.forEach(item => addItemRow(modalTargetList, item));
  closeModal();
  recalculateTotals();
}

function addItemRow(list, item) {
  const row = document.createElement('div');
  row.className = 'consumable-row';

  const info = document.createElement('div');
  info.className = 'item-info';

  const name = document.createElement('div');
  name.innerText = item.name;

  const sub = document.createElement('div');
  sub.className = 'item-sub';
  sub.innerText = `蛋白質 ${item.protein}g / 鈉 ${item.sodium}mg`;

  info.appendChild(name);
  info.appendChild(sub);

  const qtyControl = document.createElement('div');
  qtyControl.className = 'qty-control';

  const minus = document.createElement('button');
  minus.className = 'qty-btn';
  minus.innerText = '-';

  const input = document.createElement('input');
  input.type = 'number';
  input.min = '0';
  input.step = '1';
  input.value = '1';
  input.className = 'qty-input';

  const plus = document.createElement('button');
  plus.className = 'qty-btn';
  plus.innerText = '+';

  minus.onclick = () => {
    const next = Math.max(0, Number(input.value || 0) - 1);
    input.value = next;
    if (next === 0) row.remove();
    recalculateTotals();
  };
  plus.onclick = () => {
    input.value = Number(input.value || 0) + 1;
    recalculateTotals();
  };
  input.onchange = () => {
    if (Number(input.value || 0) < 0) input.value = 0;
    if (Number(input.value || 0) === 0) row.remove();
    recalculateTotals();
  };

  qtyControl.appendChild(minus);
  qtyControl.appendChild(input);
  qtyControl.appendChild(plus);

  row.appendChild(info);
  row.appendChild(qtyControl);

  const nutrients = ['saturatedFat', 'addedSugar', 'sodium', 'protein', 'solubleFiber', 'insolubleFiber', 'potassium', 'magnesium'];
  nutrients.forEach(n => row.dataset[n] = item[n]);

  list.appendChild(row);
}

function recalculateTotals() {
  totals = {
    saturatedFat: 0,
    addedSugar: 0,
    sodium: 0,
    protein: 0,
    solubleFiber: 0,
    insolubleFiber: 0,
    potassium: 0,
    magnesium: 0
  };

  document.querySelectorAll('.consumable-row').forEach(row => {
    const qty = Number(row.querySelector('.qty-input').value || 0);
    totals.saturatedFat += Number(row.dataset.saturatedfat) * qty;
    totals.addedSugar += Number(row.dataset.addedsugar) * qty;
    totals.sodium += Number(row.dataset.sodium) * qty;
    totals.protein += Number(row.dataset.protein) * qty;
    totals.solubleFiber += Number(row.dataset.solublefiber) * qty;
    totals.insolubleFiber += Number(row.dataset.insolublefiber) * qty;
    totals.potassium += Number(row.dataset.potassium) * qty;
    totals.magnesium += Number(row.dataset.magnesium) * qty;
  });

  updateDisplay();
}

function updateDisplay() {
  document.getElementById("satFat").innerText = totals.saturatedFat.toFixed(1);
  document.getElementById("sugar").innerText = totals.addedSugar.toFixed(1);
  document.getElementById("sodium").innerText = totals.sodium.toFixed(0);
  document.getElementById("protein").innerText = totals.protein.toFixed(1);
  document.getElementById("solFiber").innerText = totals.solubleFiber.toFixed(1);
  document.getElementById("insFiber").innerText = totals.insolubleFiber.toFixed(1);
  document.getElementById("potassium").innerText = totals.potassium.toFixed(0);
  document.getElementById("magnesium").innerText = totals.magnesium.toFixed(0);
}
</script>

</body>
</html>
